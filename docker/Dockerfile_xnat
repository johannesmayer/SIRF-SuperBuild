ARG BASE_IMAGE=nvidia/cuda:10.0-cudnn7-devel-ubuntu18.04
FROM ${BASE_IMAGE} as base

ENV http_proxy "http://webproxy.berlin.ptb.de:8080"
ENV https_proxy "http://webproxy.berlin.ptb.de:8080"

ARG DEBIAN_FRONTEND=noninteractive

COPY raw-ubuntu.sh .
RUN bash raw-ubuntu.sh
RUN rm raw-ubuntu.sh

# Set locale, suppress warnings
ENV LANG en_GB.UTF-8
ENV LANGUAGE en_GB:en

user root
COPY build_essential-ubuntu.sh .
RUN bash build_essential-ubuntu.sh
RUN rm build_essential-ubuntu.sh

# Python (build)
COPY build_python-ubuntu.sh .
RUN bash build_python-ubuntu.sh
RUN rm build_python-ubuntu.sh

# Gadgetron
COPY build_gadgetron-ubuntu.sh .
RUN bash build_gadgetron-ubuntu.sh
RUN rm build_gadgetron-ubuntu.sh

# SIRF external deps
COPY build_system-ubuntu.sh .
RUN bash build_system-ubuntu.sh
RUN rm build_system-ubuntu.sh


RUN apt-get install wget
RUN wget https://cmake.org/files/v3.16/cmake-3.16.7-Linux-x86_64.tar.gz
RUN tar zxvf cmake-3.16.7-Linux-x86_64.tar.gz
RUN mv cmake-3.16.7-Linux-x86_64     /opt/cmake-3.16.7
RUN ln -sf  /opt/cmake-3.16.7/bin/*    /usr/bin/

RUN ccache -o cache_dir=/opt/ccache
COPY user_sirf-ubuntu.sh .

# SIRF-SuperBuild version
ARG SIRF_SB_URL="https://github.com/johannesmayer/SIRF-SuperBuild"
ARG SIRF_SB_TAG="xnat-dcm-qfix"
# speeding up the cmake build
# (implementation note: changing this in your environment will invalidate the docker cache sadly)
ARG NUM_PARALLEL_BUILDS="20"

ARG BUILD_FLAGS="\
 -DCMAKE_BUILD_TYPE=Release\
 -DSTIR_ENABLE_OPENMP=ON -DUSE_SYSTEM_ACE=ON\
 -DUSE_SYSTEM_Armadillo=ON -DUSE_SYSTEM_Boost=ON\
 -DUSE_SYSTEM_FFTW3=ON -DUSE_SYSTEM_HDF5=ON -DUSE_ITK=ON\
 -DGadgetron_USE_CUDA=OFF\
 -DUSE_SYSTEM_SWIG=ON\
 -DUSE_NiftyPET=OFF\
 -DBUILD_siemens_to_ismrmrd=OFF\
 -DBUILD_pet_rd_tools=OFF"
ARG EXTRA_BUILD_FLAGS="-DBUILD_CIL=OFF"
RUN bash user_sirf-ubuntu.sh
RUN rm user_sirf-ubuntu.sh

# Set environment variables for SIRF
ENV PATH "/opt/conda/bin:/opt/SIRF-SuperBuild/INSTALL/bin:$PATH"
ENV LD_LIBRARY_PATH "/opt/SIRF-SuperBuild/INSTALL/lib:/opt/SIRF-SuperBuild/INSTALL/lib64:/opt/conda/lib/:$LD_LIBRARY_PATH"
ENV PYTHONPATH "/opt/SIRF-SuperBuild/INSTALL/python"
ENV SIRF_INSTALL_PATH "/opt/SIRF-SuperBuild/INSTALL"
ENV SIRF_PATH "/opt/SIRF-SuperBuild/sources/SIRF"
RUN echo $PATH

COPY /xnat/requirements.txt .

RUN curl https://bootstrap.pypa.io/pip/3.6/get-pip.py -o get-pip.py
RUN python3 get-pip.py
RUN python3 -m pip install --no-cache-dir -r requirements.txt

RUN mkdir -p /recon
RUN chmod 777 /recon
COPY /xnat/recon /recon

LABEL org.nrg.commands="[{\"name\": \"sirf_qc\", \"description\": \"Runs mr_cine_recon\", \"label\": \"sirf_qc_v1\", \"version\": \"0.1\", \"schema-version\": \"1.0\", \"type\": \"docker\", \"image\": \"johannesmayer/sirf_qc\", \"command-line\": \"/bin/bash -c 'gadgetron & python3 /recon/mr_cine_recon.py /input /output'\", \"mounts\": [{\"name\": \"raw-in\", \"writable\": false, \"path\": \"/input\"}, {\"name\": \"dcm-out\", \"writable\": true, \"path\": \"/output\"}], \"environment-variables\": {}, \"ports\": {}, \"inputs\": [{\"name\": \"other-options\", \"label\": null, \"description\": \"Other command-line flags to pass to qc_dicom_nii\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": false, \"replacement-key\": \"[OTHER_OPTIONS]\", \"sensitive\": null, \"command-line-flag\": null, \"command-line-separator\": null, \"true-value\": null, \"false-value\": null, \"select-values\": [], \"multiple-delimiter\": null}], \"outputs\": [{\"name\": \"dicom\", \"description\": \"Reconstructed dcm files\", \"required\": true, \"mount\": \"dcm-out\", \"path\": null, \"glob\": null}], \"xnat\": [{\"name\": \"sirf_qc\", \"label\": \"sirf_qc_mr\", \"description\": \"Run QC on MR raw data\", \"contexts\": [\"xnat:imageScanData\"], \"external-inputs\": [{\"name\": \"scan\", \"label\": null, \"description\": \"Input scan\", \"type\": \"Scan\", \"matcher\": \"'MR_RAW' in @.resources[*].label\", \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": null, \"via-setup-command\": null, \"user-settable\": null, \"load-children\": true}], \"derived-inputs\": [{\"name\": \"scan-raw\", \"label\": null, \"description\": \"The raw resource on the scan\", \"type\": \"Resource\", \"matcher\": \"@.label == 'MR_RAW'\", \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": \"raw-in\", \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"scan\", \"derived-from-xnat-object-property\": null, \"via-setup-command\": null, \"multiple\": false, \"parser\": null}], \"output-handlers\": [{\"name\": \"dcm-resource\", \"accepts-command-output\": \"dicom\", \"via-wrapup-command\": null, \"as-a-child-of\": \"scan\", \"type\": \"Resource\", \"label\": \"DICOM\", \"format\": null, \"description\": null, \"content\": null, \"tags\": []}]}, {\"name\": \"sirf_qc_resource\", \"label\": \"sirf_qc_mr_resource\", \"description\": \"Run QC on MR raw data resource\", \"contexts\": [\"xnat:resourceCatalog\"], \"external-inputs\": [{\"name\": \"scan-raw\", \"label\": null, \"description\": \"The raw resource on the scan\", \"type\": \"Resource\", \"matcher\": \"@.label == 'MR_RAW'\", \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": \"raw-in\", \"via-setup-command\": null, \"user-settable\": null, \"load-children\": true}], \"derived-inputs\": [{\"name\": \"scan\", \"label\": null, \"description\": \"Input scan\", \"type\": \"Scan\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": null, \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"scan-raw\", \"derived-from-xnat-object-property\": null, \"via-setup-command\": null, \"multiple\": false, \"parser\": null}], \"output-handlers\": [{\"name\": \"dcm-resource\", \"accepts-command-output\": \"dicom\", \"via-wrapup-command\": null, \"as-a-child-of\": \"scan\", \"type\": \"Resource\", \"label\": \"DICOM\", \"format\": null, \"description\": null, \"content\": null, \"tags\": []}]}], \"container-labels\": {}, \"generic-resources\": {}, \"ulimits\": {}}]"